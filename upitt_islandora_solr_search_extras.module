<?php

/**
 * @file
 * Primary hook implementations.
 */

// Permissions.
define('UPITT_ISLANDORA_SOLR_SEARCH_EXTRAS_MANAGE', 'manage upitt solr search');

/**
 * Implements hook_menu().
 */
function upitt_islandora_solr_search_extras_menu() {
  $items = array(
    'islandora/object/%islandora_object/searching_collection' => array(
      'title' => 'Search within Collection',
      'description' => 'Search the models within this Collection.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('upitt_islandora_solr_search_extras_search_specific', 2),
      'type' => MENU_CALLBACK,
      'access callback' => 'islandora_object_access_callback',
      'access arguments' => array(ISLANDORA_VIEW_OBJECTS, 2),
    ),
    'admin/islandora/tools/upitt_islandora_solr_search_extras' => array(
      'title' => 'University of Pittsburgh IsMemberOfSite Settings',
      'description' => 'Change the available Sites for adding IsMemberOfSite tags to object models.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('upitt_islandora_solr_search_extras_admin_settings'),
      'access arguments' => array(UPITT_ISLANDORA_SOLR_SEARCH_EXTRAS_MANAGE),
      'file' => 'includes/admin.form.inc',
    ),
  );
  return $items;
}

function upitt_islandora_solr_search_extras_search_specific($form, &$form_state, AbstractObject $object) {
  // The searchterms is a POST value
  $search_term = isset($_POST['searchterm']) ? $_POST['searchterm'] : '';
  $search_field = isset($_POST['field']) ? $_POST['field'] : '';
  if ($search_term) {
    if ($search_field) {
      $solr_query = format_string('(!field:!value OR !field2:!value OR !field3:!value) AND (!search_field:*!search_term*)',
        array('!field' => 'RELS_EXT_isMemberOfCollection_uri_ms',
              '!field2' => 'RELS_EXT_isPageOf_uri_ms',
              '!field3' => 'RELS_EXT_isMemberOf_uri_ms',
              '!value' => Apache_Solr_Service::escape('info:fedora/' . $object),
              '!search_field' => $search_field,
              '!search_term' => $search_term
          )
        );
    }
    else {
      // need to get the solr system's setting for this!
      $solr_query = format_string('(!field:!value OR !field2:!value OR !field3:!value) AND (catch_all_fields_mt:*!search_term* OR dc.title:*!search_term* OR dc.subject:*!search_term* OR mods_abstract_mt:*!search_term* OR mods_originInfo_dateOther_ms:*!search_term*)',
        array('!field' => 'RELS_EXT_isMemberOfCollection_uri_ms',
              '!field2' => 'RELS_EXT_isPageOf_uri_ms',
              '!field3' => 'RELS_EXT_isMemberOf_uri_ms',
              '!value' => Apache_Solr_Service::escape('info:fedora/' . $object),
              '!search_term' => $search_term
          )
        );
    }
  }
  else {
    $solr_query = format_string('!field:*!value*', array(
                '!field' => 'RELS_EXT_isMemberOfCollection_uri_ms',
                '!value' => Apache_Solr_Service::escape('info:fedora/' . $object),
        ));
  }
  $options = array('query' => array('type' => 'dismax',
      'f' => array($solr_query)));
  drupal_goto('islandora/search', $options);
}

/**
 * Implements hook_theme().
 */
function upitt_islandora_solr_search_extras_theme() {
  return array(
    'islandora_solr_wrapper_extras' => array(
      'template' => 'theme/islandora-solr-wrapper-extras',
      'variables' => array('islandora_object' => NULL),
    ),
    'islandora_basic_collection_wrapper' => array(
      'template' => 'theme/islandora-basic-collection-wrapper',
      'variables' => array('islandora_object' => NULL),
    ),      
    'islandora_objects_grid' => array(
      'template' => 'theme/islandora-objects-grid',
      'variables' => array('islandora_object' => NULL, 'objects' => NULL),
    ),
    'islandora_solr_extras' => array(
      'template' => 'theme/islandora-solr-extras',
      'variables' => array(
        'results' => NULL,
        'elements' => array(),
        'pids' => array(),
      ),
    ),
  );
}

/**
 * This responds to the module_invoke_all().
 *
 * The call from within the islandora_solr module's
 * "islandora_solr_printResults" function will be handled here.
 * The functionality here is to display as normal for all objects that
 * already have MODS info, but to load the MODS from parent objects for
 * objects that have a value in RELS_EXT_isMemberOfCollection_uri_ms.
 *
 * @param array $solr_results
 *   Array containing the Solr results which are altered trough the query
 *   processor.
 *
 * @return markup
 *   Returns the themed solr search results.
 */
function upitt_islandora_solr_search_extras_islandora_solr_printResults($solr_results) {
  $path = drupal_get_path('module', 'upitt_islandora_solr_search_extras');
  drupal_add_css("$path/css/solr_search_extras.css");

  if (variable_get('upitt_islandora_solr_search_extras_showparent_searchresults')) {
    $solr_results = islandora_solr_prepare_solr_results($solr_results);
    $object_results = $solr_results['response']['objects'];
    $object_results = islandora_solr_prepare_solr_doc($object_results);

    $elements = array();
    $elements['solr_total'] = $solr_results['response']['numFound'];
    $elements['solr_start'] = $solr_results['response']['start'];
    foreach ($object_results as $k=>$solr_result_object) {
      if (isset($object_results[$k]['datastreams'])) {
        $object_results[$k]['page_solr_doc'] = array();
        if (array_search('MODS', $object_results[$k]['datastreams']) === FALSE) {
          if (((!(isset($object_results[$k]['solr_doc']['RELS_EXT_isMemberOfCollection_uri_ms']))) ||
               (!(isset($object_results[$k]['solr_doc']['RELS_EXT_isPageOf_uri_ms']))) ||
               (!(isset($object_results[$k]['solr_doc']['RELS_EXT_isMemberOf_uri_ms'])))) &&
              (isset($object_results[$k]['object_url']))) {
            $solr_doc = _islandora_solr_pid_parent_search($object_results[$k]['PID']);
            if (is_array($solr_doc)) {
              // Keep the existing title value
              $page = $object_results[$k];
              $tmp_title = $page['dc.title']['value'];
              $object_results[$k] = $solr_doc;
              $object_results[$k]['page_solr_doc'] = $page['solr_doc'];
              if (isset($page['datastreams']) && array_search('TN', $page['datastreams'])) {
                $options = array('html' => TRUE);
                if (isset($solr_doc['object_label'])) {
                  $options['attributes']['title'] = $solr_doc['object_label'];
                }
                if (isset($solr_doc['object_url_params'])) {
                  $options['query'] = $solr_doc['object_url_params'];
                }
                if (isset($solr_doc['object_url_fragment'])) {
                  $options['fragment'] = $solr_doc['object_url_fragment'];
                }
                $page_image = theme('image', array(
                  'path' => url("islandora/object/{$page['PID']}/datastream/TN/view"),
                  'attributes' => array(),
                  'width' => '60px',
                ));
                $object_results[$k]['page_thumbnail'] = l($page_image, $page['object_url'], $options);
              }
              if ($tmp_title) {
                $object_results[$k]['solr_doc']['dc.title']['value'] = $tmp_title .
                ' in ' . l($solr_doc['solr_doc']['dc.title']['value'], $solr_doc['object_url']);
              }
            }
          }
        }
      }
      $path = url($object_results[$k]['thumbnail_url'], array('query' => $object_results[$k]['thumbnail_url_params']));
      if ($path <> '/') {
        $image = theme('image', array('path' => $path));

        $options = array('html' => TRUE);
        if (isset($object_results[$k]['object_label'])) {
          $options['attributes']['title'] = $object_results[$k]['object_label'];
        }
        if (isset($object_results[$k]['object_url_params'])) {
          $options['query'] = $object_results[$k]['object_url_params'];
        }
        if (isset($object_results[$k]['object_url_fragment'])) {
          $options['fragment'] = $object_results[$k]['object_url_fragment'];
        }
      
        // The link may be preferred to take the user to the page result.
        $fragment = ($page['object_url_fragment'] <> '') ? '#' . $page['object_url_fragment'] : '';
        $object_results[$k]['thumbnail'] = l($image, $object_results[$k]['object_url'] . $fragment, $options);
      }
      else {
        $object_results[$k]['thumbnail'] = $object_results[$k]['page_thumbnail'];
        $object_results[$k]['page_thumbnail'] = '';
      }
    }
    // Return themed search results.
    return theme('islandora_solr_extras', array('results' => $object_results, 'elements' => $elements));
  }
}

/**
 * Helper function to lookup the parent object based on a PID value.
 */
function _islandora_solr_pid_parent_search($child_pid) {
  global $_islandora_solr_queryclass;
  // !!! Set the global variable. !!!
  $_islandora_solr_queryclass = new IslandoraSolrQueryProcessor();

  $islandora_object = islandora_object_load($child_pid);
  $parent = $islandora_object->getParents();
  $page_parents = $islandora_object->relationships->get(NULL, 'isPageOf');
  $page_parent_ids = array();
  foreach ($page_parents as $page_parent) {
    $page_parent_ids[] = $page_parent['object']['value'];
  }
  $parent = array_merge($parent, $page_parent_ids);
  // Get the first value if there happens to be more than one Parent.
  $pid = str_replace(array("islandora/object/", "/", ":"), array("", "\/", "\:"), array_pop($parent));
  if ($pid) {
    // Build and execute Apache Solr query.
    $qf = variable_get('islandora_solr_query_fields', 'dc.title^5 dc.subject^2 dc.description^2 dc.creator^2 dc.contributor^1 dc.type');

    module_load_include('inc', 'islandora_solr_search', 'includes/utilities');
    $query_processor = new IslandoraSolrQueryProcessor();
    $query_processor->solrQuery = 'PID:'.$pid; // 'RELS_EXT_hasModel_uri_s:(*' . str_replace(":", "\:", implode("* OR *", $models)) . '*)';
    $query_processor->solrStart = 0;
    $query_processor->solrLimit = 1;
    $query_processor->solrParams = array(
      'fl' => "PID,fgs_label_mt,RELS_EXT_hasModel_uri_s",
      'fq' => "", // RELS_EXT_isPageOf_uri_s:",
    );
    $url = parse_url(variable_get('islandora_solr_url', 'localhost:8080/solr'));
    $solr = new Apache_Solr_Service($url['host'], $url['port'], $url['path'] . '/');
    $solr->setCreateDocuments(FALSE);
    try {
      $results = $solr->search($query_processor->solrQuery, $query_processor->solrStart, $query_processor->solrLimit, $query_processor->solrParams, 'GET');
      $tmp = json_decode($results->getRawResponse(), TRUE);
      $results = array();
      foreach ($tmp['response']['docs'] as $trip) {
        $results[$trip['PID']] = isset($trip['fgs_label_mt'][0]) ?$trip['fgs_label_mt'][0] . ' (' . $trip['PID'] . ')' : $trip['PID'];
      }
      return $results;
    }
    catch (Exception $e) {
      return array();
    }
  }
}

function upitt_islandora_solr_search_extras_preprocess_islandora_basic_collection_wrapper(&$variables, $hook) {
  $islandora_object = $variables['islandora_object'];
  $form = drupal_get_form('search_in_collection', $islandora_object->id, $islandora_object->label);
  $variables['collection_search'] = drupal_render($form);
}

function upitt_islandora_solr_search_extras_preprocess_islandora_objects_grid(&$variables) {
  $islandora_object = (isset($variables['islandora_object']) ? $variables['islandora_object'] : NULL);
  $islandora_object = menu_get_object('islandora_object', 2);

  if (!is_object($islandora_object)) {
    // Take first object and use relationships to get the parent object.
    $child_object = $variables['objects'][0];
    $link = $child_object['link'];
  }
  $form = drupal_get_form('search_in_collection', $islandora_object->id, $islandora_object->label);
  $variables['collection_search'] = drupal_render($form);
}

function upitt_islandora_solr_search_extras_form_alter(&$form, $form_state, $form_id) {
  if($form_id == 'search_in_collection' && isset($form['islandora_object_id']) && $form['islandora_object_id']['#value'] <> '') {
    $form['#action'] = '/islandora/object/' . $form['islandora_object_id']['#value'] . '/searching_collection' ;
  }
}

function search_in_collection(array $form, array &$form_state, $id, $objLabel) {
  $form = array(
    'options' => array(
      '#type' => 'fieldset',
      '#title' => t('Search within "' . $objLabel . '"'),
      '#attributes' => array('class' => array('container-inline')),
      'searchterm' => array(
        '#type' => 'textfield',
        '#value' => '',
        '#defaultvalue' => '',
        '#size' => 40,
      ),
      'field' => array(
        '#title' => t('Field'),
        '#type' => 'select',
        '#default_value' => isset($form_state['values']['field']) ? $form_state['values']['field'] : 'dc.title',
        '#options' => islandora_solr_get_fields('search_fields'),
      ),
    ),
    'islandora_object_id' => array(
      '#type' => 'hidden',
      '#value' => $id,
    ),
    'submit' => array(
      '#type' => 'submit',
      '#value' => t('Search within Collection'),
    ),
  );
  return $form;
}

/**
 * Implements hook_permission().
 */
function upitt_islandora_solr_search_extras_permission() {
  return array(
    UPITT_ISLANDORA_SOLR_SEARCH_EXTRAS_MANAGE => array(
      'title' => t('Manage solr extras'),
      'description' => t('Manage solr extras.'),
    ),
  );
}

